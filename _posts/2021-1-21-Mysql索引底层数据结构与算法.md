---
title: Mysql索引底层数据结构与算法
date: 2021-1-21 14:32:34 +0800
categories: [Mysql, 索引, 数据结构与算法]
tags: [Mysql, 索引, 索引数据结构与算法]
math: true
image: 
---

### Mysql索引数据结构

#### 索引

索引就是帮忙Mysql高效获取数据的**排好序**的**数据结构**。

#### 二叉树（Binary Search Tree）

- 特点

  右边的元素比左边的元素值大

- 缺点

  当一列有序值放入二叉树时，此时二叉树结构就相当于一个链表，查询效率变慢

  **二叉树图片**

  当查询“10”时，需要7次查找

#### 红黑树（Red-Black Tree）

又叫“二叉平衡树”

- 特点

  相对于二叉树，能自动平衡树结构

- 缺点

  当数据量很大时，红黑树的高度会很高，查询效率会变慢

  **红黑树图片**

  当查询“10”时，需要4次查找

#### B树

- 节点中的数据索引从左至右依次递增有序



#### Mysql B+树索引（B树变种，Mysql索引数据结构）

B+树不同于B树的点：

- 非叶子节点不存储data，只存储冗余索引(父节点存储每页子节点的第一个节点)，可以放更多的索引（重要）

  影响树的查找速度重要因素就是树的高度，B+ Tree因为非叶子节点不存放数据，相对于B树存放相同数据量的数据时，B+ Tree的树高度要小很多，所以B+ Tree查找数据相对于B Tree更高效。

- 叶子节点包含所有索引字段

- 叶子节点使用双向（B+ Tree为单向）磁盘地址指针连接，提高区间访问性能（重要）

  B+ Tree 叶子节点有双向指针连接，可以确定节点的磁盘文件地址，范围查找时效率很高，而B Tree叶子节点没有磁盘文件地址指针，当范围查找的索引不在同一个叶子节点时，需要再从跟节点查找索引。



#### Hash索引

- 对索引的key进行一次hash运算就可以定位出数据存储的位置
- 很多时候HASH索引比B+ Tree索引更高效
- 缺点
  - 仅支持"="，"in"，不支持范围查询
  - hash冲突问题，冲突之后会变成链表



#### Mysql文件页

文件页大小默认16KB， 如果索引列为Bigint数据类型，一个索引占用8字节，节点区间占用6字节，一个叶子节点占用1KB，那么当B+树的树高度达到3时，可以存放2000+W条数据。

在内存中二分查找一个特定的值所花费的时间原小于磁盘I/O时间。

非叶子节点常驻内存。



### InnoDB&Myisam

存储引擎生效于表。

#### 数据存储文件

- MyISAM（非聚集索引）
  - test.frm：表结构文件
  - test.MYD：表数据文件
  - test.MYI：表索引文件
- InnoDB（聚集索引）
  - test.frm：表结构文件
  - test.ibd：使用B+ Tree组织的索引结构文件



#### 查找数据过程

- MyISAM
  1. 先去MYI索引文件查找索引，得到该索引对应的磁盘地址
  2. 根据磁盘地址去MYD数据文件查找数据

- InnoDB
  1. 

### 聚集索引&聚簇索引

叶子节点存储了完整的数据记录，

聚集索引想对比非聚集索引走索引查找数据更快

InnoDB引擎，每张表只有一个聚集索引。

### 非聚集索引

索引文件和数据文件分离，叶子节点只存储了数据的磁盘文件地址。



### 稀疏索引





### 二级索引（非主键索引）

二级索引的叶子节点只存储对应的聚集索引的索引值，一般为主键。

1. 节省存储空间

   每个二级索引都存储所有数据的话，当有多个二级索引时，浪费空间。

2. 数据一致性

   同时，维护索引时也需要维护多份。

### 索引问题

#### 为什么InnoDB表必须建主键？

在InnoDB引擎下，Mysql存储数据的idb文件就是通过B+ Tree来组织的，而B+ Tree的构建需要主键字段。

在不建主键情况下，Mysql会默认选择数据不重复的列做主键，如果没有符合要求的，Mysql会建一个隐藏列（rowid）做主键。



#### 为什么推荐使用整形自增主键？

1. 整形相比于字符串比较大小效率更高

2. 自增可以更高效的排序

   1. 自增：只需要新增节点
   2. 非自增：新增节点、平衡树

   B+ Tree 排序时，当下一个值超过当页数据大小时，自增的数据只要新增一个节点就行了，而插入一个更小的值时不仅需要新增节点，可能还需要平衡树结构。

3. 整形索引相对比字符串数据量更小







### 联合索引底层数据结构

联合索引创建索引时，mysql按照创建索引字段的顺序依次排序建立B+ Tree索引。

> 这也就是为什么会有“最左前缀优化原则”，因为只有保证最左字段的值是有序的，后面的字段才能够排序，否则查询就用不到索引。
>
> 这也是为什么说索引是一种**排好序**的数据结构。



### Mysql最左前缀优化原则

比如说有一个联合索引“name_age_gender”由name、age、gender三个字段组成，那么使用如果想要使用到这个索引，查询条件必须从左至右依次查询这三个字段。





