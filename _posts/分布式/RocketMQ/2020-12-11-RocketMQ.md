---
title: RocketMQ高级原理
---

### 消息存储

* 硬盘顺序写

* 零拷贝技术

  核心思想 尽量减少文件copy技术

  利用Java NIO技术：

  * mMap 文件映射

    适合小文件

  * sendfile

    适合大文件

### 散记

文件索引

* consumerQueue
  * tag过滤索引

* indexfile
  * timestamp时间戳索引

### 问题

* hash环怎么实现的

* 广播模式  consumer不订阅也会收到消息吗

* 

  spi机制
  
* 怎么保证消息不丢失

  * 找可能丢消息的点

    * 生产者到broker

      * 事务消息保证消息不丢失
        * 事务消息实现原理

    * broker到消费者

      * 消息答复

    * broker主从之间

      有异步复制

      * 使用同步复制

    * 消息刷盘

      异步刷盘 使用缓存有可能丢失

      * 使用同步刷盘（配置文件设置同步刷盘）

    * 整个MQ挂掉

      生产者重试发送消息

      失败自定义存储消息

      然后起线程去扫描MQ

  保证消息有序性

  * 全局有序
  * 局部有序
    * 顺序消息都存到一个queue

​      消息积压

* 如果queue队列必须足够多，加消费者节点
* 再起一个topic，消费者去把消息搬到新topic里面，新消费者从新topic消费