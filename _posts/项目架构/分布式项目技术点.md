## 服务器瓶颈

当单台服务器不足以支撑网站的请求时，需要增加服务器来分担请求。比如单台服务器并发量在500，但网站的并发量在1000，那就需要另外增加一台服务器处理这多出来的500并发量。

但增加服务器的同时也会伴随着以下问题：

### 1.路由问题

怎么样将请求平均的分发到所有的服务器上呢，那可以使用如下方式解决：

- 硬件方式

  - F5

- 软件方式

  - Nginx

    但Nginx单台性能也有瓶颈，也存在单点故障问题，此时可用LVS解决。

  - 但LVS也存在单点故障问题，可用如下方式解决：

    使用keepalived软件模拟出虚拟IP，然后把虚拟IP绑定到多台LVS服务器上，浏览器访问虚拟IP时，会被路由器重定向到真实的LVS服务器，当主LVS服务器宕机时，keepalived软件会自动更新路由器中的路由表，把虚拟IP重定向到另外一台正常的LVS服务器，从而达到LVS服务器高可用的效果。

### 2.分布式session

用户在服务器1登陆，登陆状态保存在服务器1，那我下单请求打在服务器2上，但服务器2上面没有保存我的登陆信息，所以无法下单，分布式session问题可以用以下方式解决：

1. session中心 redis

   将登陆信息保存在redis中，用户请求时，从redis中查询该用户是否已经登陆，以此解决分布式Session问题。

   缺点：

   - 额外增加组件，增加系统复杂度

   - redis需要高可用

2. Session Sticky

   nginx ip_hash运算将特定用户的请求分发到特定服务器。

   缺点：

   - 单点故障问题
   - 资源浪费
   - 当超过单台服务器所能承受QPS上限时，服务器将无法提供服务

3. Session Relication

   Session复制 用户在一台服务器登陆，将用户登陆信息广播到其他服务器从而解决分布式Session问题。

   缺点：

   - 耗内存、耗宽带



### 3.资源浪费 耦合性高

比如搞活动，下单请求量上来了，那就需要增加服务器，但在增加订单处理请求能力的同时也增加了其他功能模块的性能，比如登陆、商品等，但这些模块并有出现性能问题，所以造成资源浪费。

#### 跨部门问题

比如会员部门、商品部门都需要这周五上线新功能，但上线之后商品部门功能出现bug，但会员部门新上线的功能是正常的，那这次上线到底是成功还是失败呢？

如果回滚版本，那会员部门的新功能也需要回滚掉。

此时就需要服务拆分。

### 服务拆分

单一功能或者公共功能拆分。以此来解决性能耦合、开发的问题。

但同时也带来很多问题：N个服务，服务之间的依赖变多。

比如一个下单请求，需要请求库存系统、商品系统、营销系统、积分系统还有支付系统。那此时服务间的调用需要使用RPC调用：Dubbo、Fegin、Http

- 异步调用

  最终一致性、异步下单

  - MQ

    可以解决异步、削峰、解耦

  - 问题：

    - 消息丢失

    - 消息重复

      - 接口幂等性

        接口在重复调用的情况下，返回的结果是一致的。

        需要判定正确执行还是需要回滚，数据积累又如何避免？

        1. 全局唯一ID

           比如MQ的唯一性ID，当出现重复时就不进行操作。

        2. 去重表

           比如使用Redis去重

        3. 状态机

           插入成功，状态为1，下次插入时，状态为0时才能正常插入。

    - 消息积压

    

- 分布式事务

  比如使用阿里中间件seta

  - 狭义分布式事务

    比如一个服务中需要请求两个数据库，那么就需要保证这两个数据库的事务性。

  - 广义分布式事务

    比如服务A需要调用服务B，那么服务B就需要保证服务B的事务性。

### 微服务

微服务解决的是软件开发中一直追求的高内聚+低耦合，单一职责原则。

## 数据库瓶颈

因为应用服务器是无状态的，所以可以通过增加服务器数量横向扩容解决服务器性能瓶颈。但是数据库是有状态的，当数据库出现性能瓶颈时，不能通过以上方式解决。解决方式如下：

### 更换数据库

Mysql > Redis > Oracle > TiDB，这个数据库性能不行，直接更换性能更好的数据库。

读多写少比如访问商品 ，可以将商品信息保存在Redis中，搜索使用ElasticSearch内存搜索，数据需要全量或增量的从关系型数据同步到Redis或ES中。

### 分库分表（读写分离）

将数据分片保存在不同的数据库不同的表中，从而降低每个表的数据量。

1. 应用层分片：jdbc应用层：shardingsphere、tddl

   将数据分片逻辑写在应用中，所有数据库请求经过分片逻辑计算之后路由到对应的数据库和表中。

   优点：

   - 性能更好

   缺点：

   - 侵入代码
   - 不支持多语言

2. 代理层分片：proxy代理层：mycat、mysql-proxy

   所有的数据库请求都路由到代理层Mycat，Mycat再根据分片逻辑、分片规则路由到对应的数据库和表中。

   优点：

   - 对代码领侵入
   - 跨语言

   缺点：

   - 因为多了一次请求，所以性能较应用层分片更低







